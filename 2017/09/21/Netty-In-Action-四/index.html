<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="netty,读书笔记," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="引言&amp;emsp; &amp;emsp; 网络应用程序的主要功能是传输数据，而数据传输的方式有多种，我们在实际应用中根据具体的需求来选择合适的方式。使用过Java网络库的人都知道，如果我们想将阻塞应用转变为非阻塞应用会非常困难，因为他们用的是两套完全不同的API。 &amp;emsp; &amp;emsp; 而Netty则提供了一套统一的网络API，如果我们想要改变网络传输方式，我们不需要修改大量的代码。这使得我们的工作效">
<meta name="keywords" content="netty,读书笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="Netty In Action(四)">
<meta property="og:url" content="http://lanxinglan.cn/2017/09/21/Netty-In-Action-四/index.html">
<meta property="og:site_name" content="蓝星的博客">
<meta property="og:description" content="引言&amp;emsp; &amp;emsp; 网络应用程序的主要功能是传输数据，而数据传输的方式有多种，我们在实际应用中根据具体的需求来选择合适的方式。使用过Java网络库的人都知道，如果我们想将阻塞应用转变为非阻塞应用会非常困难，因为他们用的是两套完全不同的API。 &amp;emsp; &amp;emsp; 而Netty则提供了一套统一的网络API，如果我们想要改变网络传输方式，我们不需要修改大量的代码。这使得我们的工作效">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://lanxinglan.cn/2017/09/21/Netty-In-Action-四/img1.png">
<meta property="og:image" content="http://lanxinglan.cn/2017/09/21/Netty-In-Action-四/img2.png">
<meta property="og:image" content="http://lanxinglan.cn/2017/09/21/Netty-In-Action-四/img3.png">
<meta property="og:image" content="http://lanxinglan.cn/2017/09/21/Netty-In-Action-四/img4.png">
<meta property="og:updated_time" content="2017-09-22T04:18:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Netty In Action(四)">
<meta name="twitter:description" content="引言&amp;emsp; &amp;emsp; 网络应用程序的主要功能是传输数据，而数据传输的方式有多种，我们在实际应用中根据具体的需求来选择合适的方式。使用过Java网络库的人都知道，如果我们想将阻塞应用转变为非阻塞应用会非常困难，因为他们用的是两套完全不同的API。 &amp;emsp; &amp;emsp; 而Netty则提供了一套统一的网络API，如果我们想要改变网络传输方式，我们不需要修改大量的代码。这使得我们的工作效">
<meta name="twitter:image" content="http://lanxinglan.cn/2017/09/21/Netty-In-Action-四/img1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lanxinglan.cn/2017/09/21/Netty-In-Action-四/"/>





  <title>Netty In Action(四) | 蓝星的博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">蓝星的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">蓝星</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lanxinglan.cn/2017/09/21/Netty-In-Action-四/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="蓝星">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝星的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Netty In Action(四)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-21T15:46:18+08:00">
                2017-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/读书笔记/" itemprop="url" rel="index">
                    <span itemprop="name">读书笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/09/21/Netty-In-Action-四/" class="leancloud_visitors" data-flag-title="Netty In Action(四)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>&emsp; &emsp; 网络应用程序的主要功能是传输数据，而数据传输的方式有多种，我们在实际应用中根据具体的需求来选择合适的方式。使用过Java网络库的人都知道，如果我们想将阻塞应用转变为非阻塞应用会非常困难，因为他们用的是两套完全不同的API。</p>
<p>&emsp; &emsp; 而Netty则提供了一套统一的网络API，如果我们想要改变网络传输方式，我们不需要修改大量的代码。这使得我们的工作效率大大提升。</p>
<h3 id="案例研究：改变传输方式"><a href="#案例研究：改变传输方式" class="headerlink" title="案例研究：改变传输方式"></a>案例研究：改变传输方式</h3><p>&emsp; &emsp; 为了说明数据时如何传输的，我们写一个简单的服务器程序，这个程序接受新的连接并向客户写一个“Hi”字符串。</p>
<h4 id="不使用Netty的IO-NIO"><a href="#不使用Netty的IO-NIO" class="headerlink" title="不使用Netty的IO/NIO"></a>不使用Netty的IO/NIO</h4><p>&emsp; &emsp; 首先我们先看下不使用Netty的阻塞IO程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlainOioServer</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serve</span><span class="params">(<span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            <span class="keyword">final</span> ServerSocket socket = <span class="keyword">new</span> ServerSocket(port);              <span class="comment">//1</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> Socket clientSocket = socket.accept();             <span class="comment">//2</span></div><div class="line">                    System.out.println(<span class="string">"Accepted connection from "</span> +</div><div class="line">                            clientSocket);</div><div class="line">                    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;                              <span class="comment">//3</span></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            OutputStream out;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                out = clientSocket.getOutputStream();</div><div class="line">                                out.write(<span class="string">"Hi!\r\n"</span>.getBytes(Charset.forName(<span class="string">"UTF-8"</span>))); <span class="comment">//4 </span></div><div class="line">                                out.flush();</div><div class="line">                                clientSocket.close();                        <span class="comment">//5</span></div><div class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                                e.printStackTrace();</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                    clientSocket.close();</div><div class="line">                                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                                    <span class="comment">// ignore on close</span></div><div class="line">                                &#125;</div><div class="line">                            &#125; &#125;</div><div class="line">                    &#125;).start();                                              <span class="comment">//6</span></div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125; &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>绑定服务器的端口</li>
<li>接受新的连接</li>
<li>创建新的线程处理连接</li>
<li>向客户端写消息</li>
<li>写完成后关闭连接</li>
<li>启动线程</li>
</ol>
<p>&emsp; &emsp; 这段程序可以很好的工作，但一旦我们发现阻塞IO扩展性比较差而不能满足我们的需求时，我们会发现将其修改为异步程序是多么的困难，因为两套API是完全不同的。我们只有另写一套，如下代码所示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlainNioServer</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serve</span><span class="params">(<span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            System.out.println(<span class="string">"Listening for connections on port "</span> + port);</div><div class="line">            ServerSocketChannel serverChannel;</div><div class="line">            Selector selector;</div><div class="line">            serverChannel = ServerSocketChannel.open();</div><div class="line">            ServerSocket ss = serverChannel.socket();</div><div class="line">            InetSocketAddress address = <span class="keyword">new</span> InetSocketAddress(port);</div><div class="line">            ss.bind(address);                                                <span class="comment">//1</span></div><div class="line">            serverChannel.configureBlocking(<span class="keyword">false</span>);</div><div class="line">            selector = Selector.open();                                     <span class="comment">//2</span></div><div class="line">            serverChannel.register(selector, SelectionKey.OP_ACCEPT);       <span class="comment">//3</span></div><div class="line">            <span class="keyword">final</span> ByteBuffer msg = ByteBuffer.wrap(<span class="string">"Hi!\r\n"</span>.getBytes());</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    selector.select();                                      <span class="comment">//4</span></div><div class="line">                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                    ex.printStackTrace();</div><div class="line">                    <span class="comment">// handle in a proper way</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                Set&lt;SelectedKey&gt; readyKeys = selector.selectedKeys();        <span class="comment">//5</span></div><div class="line">                Iterator&lt;SelectedKey&gt; iterator = readyKeys.iterator();</div><div class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</div><div class="line">                    SelectionKey key = iterator.next();</div><div class="line">                    iterator.remove();</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (key.isAcceptable()) &#123;                            <span class="comment">//6</span></div><div class="line">                            ServerSocketChannel server = (ServerSocketChannel)</div><div class="line">                                    key.channel();</div><div class="line">                            SocketChannel  client = server.accept();</div><div class="line">                            System.out.println(<span class="string">"Accept connection from "</span> + client);</div><div class="line">                            client.configureBlocking(<span class="keyword">false</span>);</div><div class="line">                            client.register(selector, SelectionKey.OP_WRITE | </div><div class="line">                                    SelectionKey.OP_READ, msg.duplicate());     <span class="comment">//7</span></div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (key.isWritable()) &#123;                                 <span class="comment">//8</span></div><div class="line">                            SocketChannel client = (SocketChannel) key.channel();</div><div class="line">                            ByteBuffer buffer = (ByteBuffer) key.attachment();</div><div class="line">                            <span class="keyword">while</span> (buffer.hasRemaining()) &#123;</div><div class="line">                                <span class="keyword">if</span> (client.write(buffer) == <span class="number">0</span>) &#123;                <span class="comment">//9</span></div><div class="line">                                    <span class="keyword">break</span>;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                            client.close();                                     <span class="comment">//10</span></div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                        key.cancel();</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            key.channel().close();</div><div class="line">                        &#125; <span class="keyword">catch</span> (IOException cex) &#123;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>绑定服务器端口</li>
<li>打开Selector处理Channel</li>
<li>将ServerChannel注册到Selector上，并监听新连接到来事件</li>
<li>阻塞等待可执行的事件</li>
<li>获取所有可执行事件的实例</li>
<li>检测该事件是否是新连接事件</li>
<li>接受新的连接并将其注册到Selector上，监听该连接的读写事件</li>
<li>检测该事件是否是可写事件</li>
<li>向客户端写数据。当网络饱和的情况下一次可能写不完，当网络可写时将剩余的数据写入</li>
<li>关闭连接</li>
</ol>
<p>&emsp; &emsp; 如上所示，新的程序和之前的完全不同，尽管他们的功能是一样的。下面我们看下使用Netty来转换传输方式。</p>
<h4 id="使用Netty的IO-NIO"><a href="#使用Netty的IO-NIO" class="headerlink" title="使用Netty的IO/NIO"></a>使用Netty的IO/NIO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyOioServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">server</span><span class="params">(<span class="keyword">int</span> port)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">final</span> ByteBuf buf = Unpooled.unreleasableBuffer(</div><div class="line">                Unpooled.copiedBuffer(<span class="string">"Hi!\r\n"</span>, Charset.forName(<span class="string">"UTF-8"</span>)));</div><div class="line">        EventLoopGroup group = <span class="keyword">new</span> OioEventLoopGroup();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();                   <span class="comment">//1</span></div><div class="line">            b.group(group)                                               <span class="comment">//2</span></div><div class="line">                    .channel(OioServerSocketChannel.class)</div><div class="line">                    .localAddress(<span class="keyword">new</span> InetSocketAddress(port))</div><div class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;    <span class="comment">//3</span></div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span></span></div><div class="line"><span class="function">                                <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                            ch.pipeline().addLast(</div><div class="line">                                    <span class="keyword">new</span> ChannelInboundHandlerAdapter() &#123; <span class="comment">//4</span></div><div class="line"></div><div class="line">                                        <span class="meta">@Override</span></div><div class="line">                                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">                                                ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                                            ctx.write(buf.duplicate())</div><div class="line">                                                    .addListener(ChannelFutureListener.CLOSE);  <span class="comment">//5</span></div><div class="line">                                        &#125;</div><div class="line">                                    &#125;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">            ChannelFuture f = b.bind().sync();                              <span class="comment">//6</span></div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            group.shutdownGracefully().sync();                              <span class="comment">//7</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建ServerBootstrap</li>
<li>使用OioEventLoopGroup阻塞模式</li>
<li>指定ChannelInitializer</li>
<li>向Pipline中新增handler用来处理新的连接</li>
<li>向客户端写数据，并增加Listener监听器，一旦数据写完就关闭连接</li>
<li>绑定Server开始接受连接</li>
<li>释放所有资源</li>
</ol>
<p>&emsp; &emsp; 如果我们想要将其修改为非阻塞(NIO)网络应用，我们只需要修改少部分代码即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyNioServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">server</span><span class="params">(<span class="keyword">int</span> port)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">final</span> ByteBuf buf = Unpooled.unreleasableBuffer(</div><div class="line">                Unpooled.copiedBuffer(<span class="string">"Hi!\r\n"</span>, Charset.forName(<span class="string">"UTF-8"</span>)));</div><div class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();                   <span class="comment">//1</span></div><div class="line">            b.group(group)                                               <span class="comment">//2</span></div><div class="line">                    .channel(NioServerSocketChannel.class)</div><div class="line">                    .localAddress(<span class="keyword">new</span> InetSocketAddress(port))</div><div class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;    <span class="comment">//3</span></div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span></span></div><div class="line"><span class="function">                                <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                            ch.pipeline().addLast(</div><div class="line">                                    <span class="keyword">new</span> ChannelInboundHandlerAdapter() &#123; <span class="comment">//4</span></div><div class="line"></div><div class="line">                                        <span class="meta">@Override</span></div><div class="line">                                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">                                                ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                                            ctx.write(buf.duplicate())</div><div class="line">                                                    .addListener(ChannelFutureListener.CLOSE);  <span class="comment">//5</span></div><div class="line">                                        &#125;</div><div class="line">                                    &#125;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">            ChannelFuture f = b.bind().sync();                              <span class="comment">//6</span></div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            group.shutdownGracefully().sync();                              <span class="comment">//7</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp; &emsp; 我们只需要将OioEventLoopGroup修改为NioEventLoopGroup并将OioServerSocketChannel修改为NioServerSocketChannel即可。</p>
<h3 id="传输API"><a href="#传输API" class="headerlink" title="传输API"></a>传输API</h3><p>&emsp; &emsp; 传输API的核心是Channel接口，所有的输出流操作都用到了传输API，如下图所示Channel接口的层次接口图:</p>
<p>​                        <img src="/2017/09/21/Netty-In-Action-四/img1.png" alt="Channel的层次结构图" title="Channel的层次结构图"></p>
<p>&emsp; &emsp; 如上图所示，每个Channel都会分配一个ChannelPipeline和ChannelConfig。ChannelConfig负责存储配置信息并允许在运行期间修改。传输有特殊的配置而仅仅实现了ChannelConfig接口。ChannelPipeline则持有所有用于处理输入(inbound)和输出(outboud)流的ChannelHandler。这些Handler使我们能够响应网络状态变化或者处理数据。</p>
<p>到目前为止，我们可以用ChannelHandler处理以下事情：</p>
<ul>
<li>将数据从一种类型转换为另一种类型</li>
<li>异常提醒</li>
<li>Channel激活/暂停提醒</li>
<li>Channel注册/注销EventLoop提醒</li>
<li>用户特性事件提醒</li>
</ul>
<p>&emsp; &emsp; 这些ChannelHandler在ChannelPipeline中像链条一样一个一个执行。如果我们使用过Servlet，我们会发现他们很相似。</p>
<blockquote>
<h4 id="ChannelPipeline"><a href="#ChannelPipeline" class="headerlink" title="ChannelPipeline"></a>ChannelPipeline</h4><p>ChannelPipeline使用了拦截过滤器模式，这意味着你可以加入不同的CHannelHandler并且拦截ChannelPipeline中的数据或事件。这个和Unix中的管道(pipes，pipes可以将不同的命令串起来)很相似</p>
</blockquote>
<p>&emsp; &emsp; 我们可以在程序运行期间修改ChannelPipeline，可以在任何需要时刻向其添加/移除ChannelHandler。这样我们就运用Netty构造高度灵活的应用程序。</p>
<p>&emsp; &emsp; 除了可以获得ChannelPipeline和ChannelConfig外，Channel本身还提供了很多方法，如下表列出了一些重要的方法。</p>
<table>
<thead>
<tr>
<th style="text-align:center">方法名</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">eventLoop()</td>
<td style="text-align:center">返回该Channel注册的EventLoop</td>
</tr>
<tr>
<td style="text-align:center">popline()</td>
<td style="text-align:center">返回该Channel所在的ChannelPipeline</td>
</tr>
<tr>
<td style="text-align:center">isActive()</td>
<td style="text-align:center">判断该CHannel是否激活，也就是是否连接到另一端</td>
</tr>
<tr>
<td style="text-align:center">localAddress()</td>
<td style="text-align:center">返回本地绑定的SocketAddress</td>
</tr>
<tr>
<td style="text-align:center">remoteAddress()</td>
<td style="text-align:center">返回远端绑定的SocketAddress</td>
</tr>
<tr>
<td style="text-align:center">write()</td>
<td style="text-align:center">向另一端写数据。写的数据通过ChannelPipeline传输</td>
</tr>
</tbody>
</table>
<p>&emsp; &emsp; 为了向远端写数据，我们调用Channel的write()方法，如下面代码所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Channel channel = ...</div><div class="line">    ByteBuf buf = Unpooled.copiedBuffer(<span class="string">"your data"</span>, CharsetUtil.UTF_8);    <span class="comment">//1</span></div><div class="line">    ChannelFuture cf = channel.write(buf);                                  <span class="comment">//2</span></div><div class="line">    cf.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;                    		<span class="comment">//3</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;                                       <span class="comment">//4</span></div><div class="line">                System.out.println(“Write successful“);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                System.err.println(“Write error“);                          <span class="comment">//5</span></div><div class="line">                future.cause().printStacktrace();</div><div class="line">            &#125; &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<ol>
<li>创建ByteBuf用来存储需要写的数据</li>
<li>写数据</li>
<li>添加ChannelFutureListener监听数据是否写完</li>
<li>正常写完数据</li>
<li>写数据异常</li>
</ol>
<p>&emsp; &emsp; 需要注意的是Channel是线程安全的，也就是说其所有操作都是线程安全的。这样我们就可以存储一个Channel的引用然后在任何时刻都可以通过他向远端写数据。下面是Netty在多线程下写数据的代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Channel channel = ...</div><div class="line">    <span class="keyword">final</span> ByteBuf buf = Unpooled.copiedBuffer(„your data“,</div><div class="line">            CharsetUtil.UTF_8);                                              <span class="comment">//1</span></div><div class="line">    Runnable writer = <span class="keyword">new</span> Runnable() &#123;                                       <span class="comment">//2</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            channel.write(buf.duplicate());</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    Executor executor = Executors.newChachedThreadPool();                    <span class="comment">//3</span></div><div class="line">            <span class="comment">// write in one thread</span></div><div class="line">            executor.execute(writer);                                         <span class="comment">//4</span></div><div class="line">            <span class="comment">// write in another thread</span></div><div class="line">            executor.execute(writer);                                          <span class="comment">//5</span></div><div class="line">            ...</div></pre></td></tr></table></figure>
<ol>
<li>创建ByteBuf用来存储需要写的数据</li>
<li>创建向Channel写数据的Runnable</li>
<li>获取线程执行器Executor</li>
<li>执行Runnable任务</li>
<li>在另一个线程中执行Runnable任务</li>
</ol>
<p>Channel可以保证按照我们传数据的顺序来写数据。</p>
<h3 id="Netty包含的Transport"><a href="#Netty包含的Transport" class="headerlink" title="Netty包含的Transport"></a>Netty包含的Transport</h3><p>&emsp; &emsp; Netty自带了一些我们可以使用的传输协议，尽管不全，但也足够我们使用了。如下表所示为Netty中包含的传输</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">所在包</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">NIO</td>
<td style="text-align:center">io.netty.channel.socket.nio</td>
<td style="text-align:center">以java.nio.channels包为基础，同时使用了选择器方法(selector)</td>
</tr>
<tr>
<td style="text-align:center">OIO</td>
<td style="text-align:center">io.netty.channel.socket.oio</td>
<td style="text-align:center">以java.net包为基础，使用了阻塞IO流</td>
</tr>
<tr>
<td style="text-align:center">Local</td>
<td style="text-align:center">io.netty.channel.local</td>
<td style="text-align:center">在虚拟机之间通信</td>
</tr>
<tr>
<td style="text-align:center">Embedded</td>
<td style="text-align:center">io.netty.channel.embedded</td>
<td style="text-align:center">专门供测试ChannelHandler使用，可以在无网状态下运行ChannelHandler</td>
</tr>
</tbody>
</table>
<h4 id="NIO-非阻塞IO"><a href="#NIO-非阻塞IO" class="headerlink" title="NIO-非阻塞IO"></a>NIO-非阻塞IO</h4><p>&emsp; &emsp; NIO传输是目前使用最多的。它基于Selector模式提供了完全异步的IO操作。用户可以通过注册来立即获取chanel状态变化。Channel变化可以分为以下几种</p>
<ul>
<li>一个新的Channel准备好被接收(新的连接到来)</li>
<li>Channel建立连接成功</li>
<li>Channel接受到新的数据并且可读</li>
<li>CHannel可发送数据</li>
</ul>
<p>&emsp; &emsp; 程序会对这些状态变更的事件做出相应的处理然后重置他们以便下次变更到来时重新相应。这里会有一个线程对Channel进行检测其状态是否变更，如果变更了就将其归类。</p>
<p>SelectionKey中定义的可订阅事件如下：</p>
<ul>
<li>OP_ACCEPT：提醒有新连接到来，建立Channel</li>
<li>OP_CONNECT：提醒连接完成</li>
<li>OP_READ：Channel中数据可读</li>
<li>OP_WRITE：提醒Channel中可写数据。大部分情况下没问题，但是有些系统会出现网络堵塞问题，当远端消费数据的速度小于我们写数据的速度时会出现这种问题</li>
</ul>
<p>&emsp; &emsp; Netty的NIO传输内部使用了这种模型来接受和发送数据，外部封装成统一的API给用户使用，掩盖了内部所有的实现细节。下图为Netty内部流程图。</p>
<p>​                        <img src="/2017/09/21/Netty-In-Action-四/img2.png" alt="Selector逻辑流程图" title="Selector逻辑流程图"></p>
<ol>
<li>新建的Channel注册到Selector上</li>
<li>选择处理器的变化通知</li>
<li>已经注册过的Channel</li>
<li>Selector.select()方法会一直堵塞直到有Channel状态变化或者超时</li>
<li>检测是否有状态变化</li>
<li>处理所有发生状态变化的Channel</li>
<li>在同一个线程中处理其他任务</li>
</ol>
<p>&emsp; &emsp; 这种模式的传输方式在处理任务的时候比起来阻塞传输(OIO)传输多少会有点延迟，这是由于Selector工作模式引起的，因为其收到状态变更的消息通知需要一定得时间。但这仅仅是毫秒级的，我们可以通过增加网络宽带来减少延迟。</p>
<p>&emsp; &emsp; 目前NIO传输适用的一个重要功能是“零文件拷贝”(zero-file-copy)。这个特性可以让我们快速有效地将文件系统的数据传输到网络栈中而不需要将数据先从内存空间拷贝到用户空间。</p>
<p>&emsp; &emsp; 但是并不是所有的操作系统都支持这种特性，另外，这种特性不适用于传输加密/压缩的数据，要传输这样的数据必须先将其传输到用户空间进行加工处理。所以只有传输原始数据才能使用这种特性。Ftp或者Http服务器下载大文件时可以使用这个特性。</p>
<h4 id="OIO-Old-blocking-IO"><a href="#OIO-Old-blocking-IO" class="headerlink" title="OIO-Old blocking IO"></a>OIO-Old blocking IO</h4><p>&emsp; &emsp; 在传统的Java net中，我们为每一个socket分配一个线程处理任务。或者多个socket共享一个线程，但是当一个socket堵塞时间比较长时可能导致该线程共享的所有其他socket堵塞。</p>
<p>&emsp; &emsp; Netty的NIO和OIO使用的是同一套API。之所以能够实现一套统一的API，Netty利用了socket上的SO_TIMEOUT属性，如果socket上的操作在一定得时间内没有完成，将会跑出SocketTimeoutException，Netty捕获该异常然后继续执行工作。然后再下一次EventLoop中，继续尝试执行。这是唯一有效的办法，但问题是抛出SocketTimeoutException是需要消耗资源的，因为它要执行StrackTrace等操作。</p>
<p>​                        <img src="/2017/09/21/Netty-In-Action-四/img3.png" alt="OIO逻辑流程图" title="OIO逻辑流程图"></p>
<ol>
<li>线程分配socket</li>
<li>socket连接远端服务器</li>
<li>读可能阻塞的socket</li>
<li>读操作完成</li>
<li>读操作完成并且获得读的数据然后处理数据</li>
<li>执行该socket提交的其他任务</li>
<li>继续循环</li>
</ol>
<h4 id="Local-虚拟机内通信"><a href="#Local-虚拟机内通信" class="headerlink" title="Local-虚拟机内通信"></a>Local-虚拟机内通信</h4><p>&emsp; &emsp; Netty可以提供本机内通信的API，该API和前面提供的API相同，并且类似于NIO是异步的。Client可以通过SocketAddress连接到本机服务器(类似于连接远程服务器一样)。需要注意的是我们在使用时客户端和服务器必须同时开着。</p>
<h4 id="Embedded-transport"><a href="#Embedded-transport" class="headerlink" title="Embedded transport"></a>Embedded transport</h4><p>&emsp; &emsp; Embedded主要用于测试ChannelHandler或者嵌入其他的ChannelHandler当做帮助类使用。</p>
<h3 id="合理选择传输类型"><a href="#合理选择传输类型" class="headerlink" title="合理选择传输类型"></a>合理选择传输类型</h3><p>&emsp; &emsp; 在实际应用中，我们需要根据实际情况选择不同的传输方式，下表是不同的协议支持的传输方式：</p>
<p>​                    <img src="/2017/09/21/Netty-In-Action-四/img4.png" alt="OIO逻辑流程图" title="OIO逻辑流程图"></p>
<p>&emsp; &emsp; 下面让我们总结下传输类型的使用场景</p>
<ul>
<li><p>低并发连接：如果并发量较低，可以先使用OIO传输模式，因为是低并发，我们不需要担心分配线程的限制，并且资源也不是问题。这时我们可能会产生什么才是低并发场景的疑问，这个很难界定。但只要记住NIO传输类型可以支持万级以及十万级的并发量。所以任何低于一千的并发量都可以称作低并发。</p>
<p>这种情况下OIO运行的会很好，但有时NIO在低并发下也会很合适。当连接非常”活”跃时，OIO的上下文切换可能会比较耗时。</p>
</li>
<li><p>高并发连接：当应用连接比较多时就需要选择NIO传输方式。</p>
</li>
<li><p>低延迟：如果对实时性要求较高，首先使用OIO。但仍然需要权衡下，因为低延迟意味着要消耗更多的线程</p>
</li>
<li><p>阻塞代码：如果你正在改造老代码，而老代码是线程阻塞的。对Netty来说，将阻塞的IO修改为非阻塞的代价较大，或许只能重写代码。因此可以先将其转换为OIO，然后在需要的时候修改为NIO</p>
</li>
<li><p>本机内通信：利用Local实现本机内通信</p>
</li>
<li><p>测试ChannelHandler：利用Embedded可以进行ChannelHandler测试</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">程序需求</th>
<th style="text-align:center">推荐的传输类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">低并发</td>
<td style="text-align:center">OIO</td>
</tr>
<tr>
<td style="text-align:center">高并发</td>
<td style="text-align:center">NIO</td>
</tr>
<tr>
<td style="text-align:center">低延迟</td>
<td style="text-align:center">OIO</td>
</tr>
<tr>
<td style="text-align:center">阻塞代码改造</td>
<td style="text-align:center">OIO</td>
</tr>
<tr>
<td style="text-align:center">本机通信</td>
<td style="text-align:center">Local</td>
</tr>
<tr>
<td style="text-align:center">测试ChannelHandler</td>
<td style="text-align:center">Embedded</td>
</tr>
</tbody>
</table>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/netty/" rel="tag"># netty</a>
          
            <a href="/tags/读书笔记/" rel="tag"># 读书笔记</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/19/Netty-In-Action-三/" rel="next" title="Netty In Action(三)">
                <i class="fa fa-chevron-left"></i> Netty In Action(三)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/28/Netty-In-Action-五/" rel="prev" title="Netty In Action(五-Buffers)">
                Netty In Action(五-Buffers) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="uyan_frame"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/head.png"
               alt="蓝星" />
          <p class="site-author-name" itemprop="name">蓝星</p>
           
              <p class="site-description motion-element" itemprop="description">Welcome to my home!</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/lanxing" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例研究：改变传输方式"><span class="nav-number">2.</span> <span class="nav-text">案例研究：改变传输方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#不使用Netty的IO-NIO"><span class="nav-number">2.1.</span> <span class="nav-text">不使用Netty的IO/NIO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用Netty的IO-NIO"><span class="nav-number">2.2.</span> <span class="nav-text">使用Netty的IO/NIO</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#传输API"><span class="nav-number">3.</span> <span class="nav-text">传输API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ChannelPipeline"><span class="nav-number">3.1.</span> <span class="nav-text">ChannelPipeline</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Netty包含的Transport"><span class="nav-number">4.</span> <span class="nav-text">Netty包含的Transport</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NIO-非阻塞IO"><span class="nav-number">4.1.</span> <span class="nav-text">NIO-非阻塞IO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OIO-Old-blocking-IO"><span class="nav-number">4.2.</span> <span class="nav-text">OIO-Old blocking IO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Local-虚拟机内通信"><span class="nav-number">4.3.</span> <span class="nav-text">Local-虚拟机内通信</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Embedded-transport"><span class="nav-number">4.4.</span> <span class="nav-text">Embedded transport</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#合理选择传输类型"><span class="nav-number">5.</span> <span class="nav-text">合理选择传输类型</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">蓝星</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Gemini
  </a>
</div>




        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  
    

    
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2141613"></script>
      <!-- UY END -->
    
  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("VAJcdXNHnyLYgpT1G28i0Cp8-gzGzoHsz", "NVR7XnRF7tjrjxFvf3wmi2WF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
